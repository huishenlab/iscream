---
title: "Getting other data structures from iscream"
output:
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Getting other data structures from iscream}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
#bibliography: refs.bib
link-citations: yes
---

The examples here show how iscream output can be converted into other data
structures for further analysis.

```{r setup}
library(iscream)
data_dir <- system.file("extdata", package = "iscream")
bedfiles <- list.files(data_dir, pattern = "[a|b|c|d].bed.gz$", full.names = TRUE)
regions <- c(A = "chr1:1-6", B = "chr1:7-10", C = "chr1:11-14")
```

## GRanges

```{r gr, message=FALSE}
library(GenomicRanges)
```

`r Biocpkg("GenomicRanges")` can be used as the input to all of iscream's
querying functions. The output of `tabix()` and `make_mat()`, `make_bsseq_mat()`
can also be turned into `GRanges`.

### From `tabix` queries

```{r tabix}
tabix(bedfiles[1], regions) |> GRanges()
```

If the input is already a `GRanges` object, `tabix()` will also return a
`GRanges` object along with any attached metadata. With multiple input files, it
returns a `GRangesList`. `tabix()` uses `findOverlaps()` to join input metadata
with the queried data.

```{r tabix_gr}
gr <- GRanges(regions)
values(gr) <- DataFrame(
    gene = c("gene1", "gene2", "gene3"),
    some_metadata = c("s1", "s2", "s3")
)
gr
tabix(bedfiles, gr)
```

If the input BED file is not zero-based (e.g. Bismark coverage files), set
`zero_based = FALSE` in the `tabix()` call to get the correct conversion from
data frame to GenomicRanges.

### From `summarize_regions`

With a named set of regions, or with `feature_col` set with a data frame of
input regions, you'll need to `set_region_rownames` as the input to create the
GRanges object:

```{r summarize_regions}
(summary <- summarize_regions(
  bedfiles,
  regions,
  column = 4,
  set_region_rownames = TRUE,
  fun = c("sum", "mean"))
)
GRanges(rownames(summary), summary = summary)
```

If the regions vector is not named, pass the `feature` column as the GRanges
input regions:

```{r summarize_meth_regions}
(summary <- summarize_meth_regions(
  bedfiles,
  unname(regions),
  fun = c("sum", "mean"))
)
summary |> (function(.) GRanges(.$feature, summary = .[, -1]))()
```

### From `make_mat`

`make_mat()` returns a `r Biocpkg("SummarizedExperiment")` by default but can
return a `GRanges` object for dense matrices with `make_gr = TRUE`.

```{r make_mat}
make_mat(bedfiles, regions, column = 4, mat_name = "beta", make_gr = TRUE)
```

## Making `BSseq` objects

A `r Biocpkg("bsseq")` object is a type of SummarizedExperiment, but it cannot
handle sparse matrices:

```{r, eval=FALSE}
library(bsseq)
do.call(BSseq, mats)
```

## Session info

```{r si}
sessionInfo()
```
